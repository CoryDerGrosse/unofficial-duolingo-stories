<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Duolingo - Unofficial stories</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <script src="https://d3js.org/d3.v5.min.js"></script>
    <script src="js/story.js"></script>

    <link rel="stylesheet" href="css/story.css"></link>

    <script src="https://ajaxorg.github.io/ace-builds/src/ace.js" type="text/javascript" charset="utf-8"></script>
    <script src="https://ajaxorg.github.io/ace-builds/src/ext-language_tools.js" type="text/javascript" charset="utf-8"></script>
    <script src="js/custom_mode.js" type="text/javascript" charset="utf-8"></script>

    <style type="text/css" media="screen">
        #editor {
            position: absolute;
            top: 0;
            right: 0;
            bottom: 0;
            left: 0;
        }
        body {
            padding: 0;
            margin: 0;
        }

    </style>
</head>
<body>
<div style="display: grid; grid-template-columns: 50% 50%;">
    <div>
    <div id="editor" contenteditable="" style="width: 50%" >
    </div>
    </div>
    <div style="background: white; height: 100vh; overflow: scroll;">
    <div id="header" style="display: none">
        <div id="progress"><span id="progress_inside"></span></div>
    </div>
    <div id="main">

        <div id="story">

        </div>
    </div>
    <div id="footer" style="left: 50vw; right: 0px; width: 50%">
        <div id="button_next" style="display: none" class="button" onclick="addNext();">continue</div>
        <div id="button_save" class="button" onclick="saveStory();" style="float:left"><img style="display: none" src="Spinner-1s-40px.svg" height="15px">save</div>
        <div id="button_reload" class="button" onclick="updateStoryDisplay();">update</div>
    </div>
    </div>
</div>

<script>
    var langTools = ace.require("ace/ext/language_tools");
    var editor = ace.edit("editor");

    editor.session.setMode("ace/mode/javascript-custom");
    editor.setOptions({
        enableBasicAutocompletion: true,
        enableLiveAutocompletion: true
    });
    editor.setTheme("ace/theme/dracula");

    var myCompleter = {
        getCompletions: function(editor, session, pos, prefix, callback) {
            var wordList = ["gh"];
            callback(null, wordList.map(function(word) {
                return {
                    caption: word,
                    value: word
                };
            }));
        }
    };
    langTools.addCompleter(myCompleter);

editor.session.setUseWrapMode(true);
editor.resize();

editor.commands.addCommand({
    name: 'compile',
    bindKey: {win: 'Ctrl-Enter',  mac: 'Command-Enter'},
    exec: function(editor) {
        updateStoryDisplay();
    },
    readOnly: true // false if this command should not apply in readOnly mode
});

let story = undefined;
let story_id = undefined;
let languages_ids = undefined;
async function loadStory(name) {
    languages_ids = await getLanguages();
    if(name===null) {
        story = `title=...
tile_base=...
lang=nl
lang_base=en
`;
    }
    else {
        //let response = await fetch(name+".txt");
        let response = await fetch(`${backend}get_story.php?id=${name}`);
        let data = await response.json();
        story_id = data[0]["id"];
        story = data[0]["text"];
    }
    editor.setValue(story);
    updateStoryDisplay();
}
const urlParams = new URLSearchParams(window.location.search);
loadStory(urlParams.get('story'))

function updateStoryDisplay() {
    story = editor.getValue();
    processStoryFile();
    index = 0;
    d3.select("#story").selectAll("*").remove();
    addTitle();
    while (index < phrases.length) {
        document.getElementById("button_next").dataset.status = "active";
        addNext();
    }
}
updateStoryDisplay();

async function saveStory() {
    updateStoryDisplay();
    document.getElementById("button_save").getElementsByTagName("img")[0].style.display = "inline-block";
    let data = {"name": story_properties["title"], "name_base": story_properties["title_base"], "lang": languages_ids[story_properties["lang"]], "lang_base": languages_ids[story_properties["lang_base"]], "text": editor.getValue(), "change_date": new Date().now()};
    if(story_id !== undefined)
        data.id = story_id;
    console.log("save", data);
    let x = await fetch_post(backend+"set_story.php", data);
    x = await x.json();
    x = x[0];
    console.log("saved", x);
    story_id = x.id;
    document.getElementById("button_save").getElementsByTagName("img")[0].style.display = "none";
}

</script>
</body>
</html>