<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Duolingo - Unofficial stories</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <script src="https://d3js.org/d3.v5.min.js"></script>
    <script src="js/login.js"></script>

    <link rel="stylesheet" href="css/story.css" />

    <style>
        .button_story {
            width: 100px;
            height: 100px;
            display: inline-block;
            background: #0071c8;
            color: white;
            border-radius: 15px;
            border: 1px solid #005fa7;
            box-shadow: #005fa7 0 6px;
            cursor: pointer;
            box-sizing: border-box;
            margin: 0 25px;
            position: relative;
        }
        .button_story img {
            position: absolute;
            width: 120px;
            left: -11px;
            top: -11px;
        }
        .button_story:hover {
            filter: brightness(1.2);
            /*transform: translate(0, 5px);
            box-shadow: #58a700 0 0px;*/
        }
        .button_story[data-done=true] {
            background: #ffbb09;
            border: 1px solid #ffbb09;
            box-shadow: #a75c00 0 6px;
        }
        .button_story:active {
            transform: translate(0, 5px);
            box-shadow: lightgray 0 0px;
            transition: 0.1s box-shadow, 0.1s transform;
        }
        .story_title {
            display: inline-block;
            text-align: center;
            font-weight: bold;
            width: 150px;
            font-size: 17px;
            margin-top: 5px;
        }
        .story_xp {
            display: inline-block;
            text-align: center;
            font-weight: bold;
            width: 150px;
            font-size: 17px;
            margin-top: 5px;
            margin-bottom: 20px;
            color: gray;
        }

        #header {
            border-bottom: 1px solid gray;
            height: 80px;
            padding-top: 10px;
        }
        #main {
            max-width: 700px;
            padding-top: 80px;
        }
        a {
            color: black;
        }

        h1 {
            width: 100%;
            text-align: center;
        }
    </style>
</head>
<body>

<div id="header">
    <div id="login_form" style="display: none; float: right">
        <div id="login_status"></div>
        <input id=username type="text" value="" placeholder="username">
        <input id=password type="password" value="" placeholder="password">
        <button class="button" onclick="login_button();" style="float: none">Login</button>
        <button class="button" onclick="location.href = 'login.html';" style="float: none">Register</button>
    </div>
    <div id="loggedin" style="display: none; float: right">
        <span id="display_username" style="font-size: 1.2em; padding-right: 14px; display: inline-block;"></span>
        <button id="button_editor" class="button" onclick="location.href = 'editor_overview.html'+window.location.search;" style="display:none; float: none">Editor</button>
        <button class="button" onclick="button_logout();" style="float: none">Logout</button>
    </div>
</div>
<div id="main">
    <h1>Unofficial Duolingo Stories</h1>
    <p style="text-align: center">This page is a community project to bring the original <a href="https://www.duolingo.com/stories">Duolingo Stories</a> to new languages. If you want to contribute <a href="https://forum.duolingo.com/comment/38992372">tell me</a>.</p>
    <p style="text-align: center">Currently available in <a href="index.html?lang=nl">Dutch</a>, <a href="index.html?lang=el">Greek</a>, <a href="index.html?lang=no">Norwegian</a> and <a href="index.html?lang=ru">Russian</a>.</p>

    <div id="list" style="display: grid; grid-template-columns: auto auto auto auto;"></div>

    </div>

</div>
<script>

async function button_logout() {
    await logout();
    check_login();
}

async function login_button() {
    let success = await login(inputs_to_dict({username: "#username", password: "#password"}));
    if(success == false) {
        document.getElementById("login_status").innerText = "Error: username or password is wrong.";
    }
    else {
        document.getElementById("login_status").innerHTML = "Successfully logged in. Go to the <a href='index.html'>overview</a>.";
        check_login();
    }
}
async function check_login() {
    let login = await get_login();
    console.log("login", login);
    if(login === undefined) {
        document.getElementById("login_form").style.display = "block";
        document.getElementById("loggedin").style.display = "none";
    }
    else {
        document.getElementById("login_form").style.display = "none";
        document.getElementById("loggedin").style.display = "block";
        document.getElementById("button_editor").style.display = login.role != 0 ? "inline-block" : "none";
        document.getElementById("display_username").innerText = login.username;
    }
    const urlParams = new URLSearchParams(window.location.search);
    loadStory(urlParams.get('lang'), urlParams.get('lang_base') || "en");
}
check_login();

list = [];
async function loadStory(lang, lang_base) {
    let response = await fetch(`https://carex.uber.space/stories/backend/stories/get_list.php?lang=${lang}&lang_base=${lang_base}`);
    if(response.status !== 200)
        return
    let data = await response.json();
    console.log(data);
    d3.select("#list").selectAll("a").remove();
    d3.select("#list").selectAll("a").data(data).enter().append("a")
        .style("width", "150px")
        .attr("href", d=>"story.html?story="+d.id)
        .each(function (d) {
            let button = d3.select(this).append("button")
                .attr("class", "button_story")
                .attr("data-done", d=>d.time != null)
            if(d.image) {
                if(d.time != null && d.image_done != null)
                    button.append("img").attr("src", d.image_done)
                else
                    button.append("img").attr("src", d.image)
            }
            d3.select(this).append("div")
                .attr("class", "story_title")
                .text(d.name_base)
            d3.select(this).append("div")
                .attr("class", "story_xp")
                .text("+"+d.xp+"xp")
        })

}
</script>
</body>
</html>
